import os
import pandas as pd
import numpy as np
from scipy.stats import f_oneway

# --- Folder with multiple CSV files (Group 1) ---
folder_a = r"C:\Users\medin\Downloads\Migraine & altered_consciousness\absolute_power_results"

# --- CSV file for Group 2 (other phenomenon) ---
file_b = r"C:\Users\medin\Downloads\Migraine & altered_consciousness\Absolute_power_bdf_files\EEG_Absolute_Band_Powers_AllSubjects.csv"

# --- Load Group 1: combine all CSVs in the folder ---
group_a_dfs = []
for file in os.listdir(folder_a):
    if file.endswith(".csv"):
        df = pd.read_csv(os.path.join(folder_a, file), index_col=0)
        # --- Normalize absolute powers per subject ---
        df_norm = df.div(df.sum(axis=0), axis=1)  # convert to proportion per subject
        group_a_dfs.append(df_norm)
group_a = pd.concat(group_a_dfs, axis=0)

# --- Load Group 2 ---
group_b = pd.read_csv(file_b, index_col=0)
# --- Normalize absolute powers per subject ---
group_b = group_b.div(group_b.sum(axis=1), axis=0)

# --- Initialize results dictionary ---
anova_results = {}

# --- Function to compute Cohen's d ---
def cohens_d(x, y):
    nx = len(x)
    ny = len(y)
    dof = nx + ny - 2
    pooled_std = np.sqrt(((nx - 1)*np.std(x, ddof=1)**2 + (ny - 1)*np.std(y, ddof=1)**2) / dof)
    if pooled_std == 0:
        return np.nan
    return (np.mean(x) - np.mean(y)) / pooled_std

# --- Perform ANOVA for each frequency band (excluding Delta) ---
for band in group_a.index:
    if band.lower().startswith('delta'):
        continue  # skip delta

    data_a = group_a.loc[band].values if band in group_a.index else group_a[band].values
    data_b = group_b.loc[band].values if band in group_b.index else group_b[band].values

    # Remove NaNs
    data_a = data_a[~pd.isna(data_a)]
    data_b = data_b[~pd.isna(data_b)]

    if len(data_a) > 1 and len(data_b) > 1:
        f_stat, p_value = f_oneway(data_a, data_b)
        d = cohens_d(data_a, data_b)
        anova_results[band] = {
            'During Chanting Mean': np.mean(data_a),
            'Migraine Mean': np.mean(data_b),
            'F-statistic': f_stat,
            'p-value': p_value,
            "Cohen's d": d
        }
    else:
        anova_results[band] = {
            'During Chanting Mean': np.nan,
            'Migraine Mean': np.nan,
            'F-statistic': None,
            'p-value': None,
            "Cohen's d": None
        }

# --- Convert results to DataFrame ---
anova_df = pd.DataFrame.from_dict(anova_results, orient='index')
anova_df.index.name = 'Frequency Band'

# --- Display results ---
print("\n=== ANOVA Results Between Two Phenomena (Normalized Absolute Powers) ===\n")
print(anova_df.round(4))
